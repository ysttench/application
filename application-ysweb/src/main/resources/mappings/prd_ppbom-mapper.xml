<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ysttench.application.auth.settings.kernel.mapper.PpBomMapper">
	<!--mybatis ehcache缓存配置 -->
	<!-- 以下两个<cache>标签二选一,第一个可以输出日志,第二个不输出日志 <cache type="org.mybatis.caches.ehcache.LoggingEhcache" 
		/> -->
	<!-- <cache type="org.mybatis.caches.ehcache.EhcacheCache"/> -->
	<!-- 以下与实体类的中字段一致 -->
<select id="selectBom" resultType="com.ysttench.application.auth.settings.kernel.entity.PpBomFormMap">
SELECT
	T_PRD_PPBOMENTRY.FENTRYID,
	T_PRD_PPBOM.FBILLNO,
	T_PRD_PPBOMENTRY.FMOBILLNO,
	T_BD_MATERIAL.FNUMBER,
	T_BD_MATERIAL_L.FNAME,
	T_PRD_MOENTRY.FLOT,
	T_PRD_PPBOMENTRY.FNEEDQTY,
	T_BD_STOCK.FSTOCKID AS STOCKID,
	SUM( T_STK_INVENTORY.FBaseQty ) AS STOCKQTY 
FROM
	T_PRD_PPBOMENTRY
	LEFT JOIN T_PRD_PPBOM ON T_PRD_PPBOMENTRY.FID = T_PRD_PPBOM.FID
	LEFT JOIN T_BD_MATERIAL_L ON T_PRD_PPBOMENTRY.FMATERIALID = T_BD_MATERIAL_L.FMATERIALID
	LEFT JOIN T_BD_MATERIAL ON T_PRD_PPBOMENTRY.FMATERIALID = T_BD_MATERIAL.FMATERIALID
	LEFT JOIN T_PRD_PPBOMENTRY_Q ON T_PRD_PPBOMENTRY.FID = T_PRD_PPBOMENTRY_Q.FID
	LEFT JOIN T_PRD_MO ON T_PRD_PPBOM.FMOBILLNO = T_PRD_MO.FBILLNO
	LEFT JOIN T_PRD_MOENTRY ON T_PRD_MO.FID = T_PRD_MOENTRY.FID
	LEFT JOIN T_STK_INVENTORY ON T_STK_INVENTORY.FMATERIALID = T_BD_MATERIAL.FMASTERID
	LEFT JOIN T_BD_STOCK ON T_STK_INVENTORY.FSTOCKID = T_BD_STOCK.FSTOCKID
	LEFT JOIN T_ORG_ORGANIZATIONS_L ON T_STK_INVENTORY.FSTOCKORGID = T_ORG_ORGANIZATIONS_L.FORGID 
WHERE
	T_STK_INVENTORY.FBaseQty != 0  AND T_PRD_PPBOMENTRY.FNEEDQTY >= 1
	<if test="organ != null">
	AND T_ORG_ORGANIZATIONS_L.FORGID ='${organ}'
	</if>
<if test="fmobillno != null">
	 AND T_PRD_PPBOM.FMOBILLNO ='${fmobillno}' 
</if>
<if test="flot != null">
    AND T_PRD_MOENTRY.FLOT='${flot}'
</if>
GROUP BY
	T_PRD_PPBOMENTRY.FNEEDQTY,
	T_PRD_PPBOMENTRY.FENTRYID,
	T_PRD_PPBOM.FBILLNO,
	T_PRD_PPBOMENTRY.FMOBILLNO,
	T_BD_MATERIAL.FNUMBER,
	T_BD_MATERIAL_L.FNAME,
	T_PRD_MOENTRY.FLOT,
	T_BD_STOCK.FSTOCKID,
	T_STK_INVENTORY.FBaseQty
</select>
<select id="findDetailBom" resultType="com.ysttench.application.auth.settings.kernel.entity.PpBomFormMap">
SELECT
	T_BD_MATERIAL.FNUMBER AS MATERILNUMBER,
	UNIT1.FNAME AS FNAME1,
	UNIT3.FNAME AS FNAME3,
	T_PRD_PPBOMENTRY.FNEEDQTY AS FAPPQTY,
	T_PRD_PPBOMENTRY.FMOID,
	T_PRD_PPBOMENTRY.FMOBILLNO,
	T_PRD_PPBOMENTRY.FENTRYID AS FMOENTRYID,
	T_PRD_PPBOMENTRY.FMOENTRYSEQ,
	T_BD_DEPARTMENT.FNUMBER AS DEPARTNUMBER,
	T_PRD_PPBOMENTRY.FMATERIALID,
	T_BD_STOCK.FNUMBER AS STOCKNUMBER,
	T_BD_MATERIALSTOCK.FISBATCHMANAGE,
	T_PRD_MOENTRY.FLOT 
FROM
	T_PRD_PPBOMENTRY
	LEFT JOIN T_PRD_PPBOM ON T_PRD_PPBOMENTRY.FID = T_PRD_PPBOM.FID
	LEFT JOIN T_BD_MATERIAL ON T_PRD_PPBOMENTRY.FMATERIALID = T_BD_MATERIAL.FMATERIALID
	LEFT JOIN T_BD_UNIT_L UNIT1 ON T_PRD_PPBOMENTRY.FUNITID = UNIT1.FUNITID
	LEFT JOIN T_BD_UNIT_L UNIT3 ON T_PRD_PPBOMENTRY.FBASEUNITID = UNIT3.FUNITID
	LEFT JOIN T_PRD_PPBOMENTRY_C ON T_PRD_PPBOMENTRY.FID = T_PRD_PPBOMENTRY_C.FID
	LEFT JOIN T_PRD_MO ON T_PRD_PPBOMENTRY.FMOBILLNO = T_PRD_MO.FBILLNO
	LEFT JOIN T_PRD_MOENTRY ON T_PRD_MO.FID = T_PRD_MOENTRY.FID
	LEFT JOIN T_BD_DEPARTMENT ON T_BD_DEPARTMENT.FDEPTID = T_PRD_PPBOM.FWORKSHOPID
	LEFT JOIN T_STK_INVENTORY ON T_STK_INVENTORY.FMATERIALID = T_BD_MATERIAL.FMASTERID
	LEFT JOIN T_BD_STOCK ON T_STK_INVENTORY.FSTOCKID = T_BD_STOCK.FSTOCKID
	LEFT JOIN T_ORG_ORGANIZATIONS_L ON T_STK_INVENTORY.FSTOCKORGID = T_ORG_ORGANIZATIONS_L.FORGID
	LEFT JOIN T_BD_MATERIALSTOCK ON T_BD_MATERIAL.FMaterialID = T_BD_MATERIALSTOCK.FMATERIALID
	<if test="fentryid != null">
	WHERE
	T_PRD_PPBOMENTRY.FENTRYID IN (${fentryid})
	</if>
	<if test="organ != null">
	AND T_ORG_ORGANIZATIONS_L.FORGID ='${organ}'
	</if>
GROUP BY
	T_BD_MATERIAL.FNUMBER,
	UNIT1.FNAME,
	UNIT3.FNAME,
	T_PRD_PPBOMENTRY.FNEEDQTY,
	T_BD_STOCK.FNUMBER,
	T_PRD_PPBOMENTRY.FMOID,
	T_PRD_PPBOMENTRY.FMOBILLNO,
	T_PRD_PPBOMENTRY.FENTRYID,
	T_PRD_PPBOMENTRY.FMOENTRYSEQ,
	T_BD_DEPARTMENT.FNUMBER,
	T_PRD_PPBOMENTRY.FMATERIALID,
	T_BD_STOCK.FNUMBER,
	T_BD_MATERIALSTOCK.FISBATCHMANAGE,
	T_PRD_MOENTRY.FLOT 
	ORDER BY T_PRD_PPBOMENTRY.FENTRYID DESC
</select>
<select id="getorg" resultType="com.ysttench.application.auth.settings.kernel.entity.PpBomFormMap">
SELECT DISTINCT
	( T_ORG_ORGANIZATIONS.FNUMBER ) 
FROM
	T_ORG_ORGANIZATIONS
	LEFT JOIN T_ORG_ORGANIZATIONS_L ON T_ORG_ORGANIZATIONS.FORGID = T_ORG_ORGANIZATIONS_L.FORGID 
WHERE
	T_ORG_ORGANIZATIONS_L.FORGID = '${organ}'
</select>
</mapper>